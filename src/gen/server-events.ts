import { addTemplate, addTypeTemplate } from '@nuxt/kit'
import { genImport } from 'knitwork'

import type { Nuxt } from 'nuxt/schema'
import type { NuxtEasyWebSocketContext } from '../types'
import { MODULE_TMP_PATH } from '../constants'

export function generateServerEvents(
  { resolver, serverRoutes, serverConnection }: NuxtEasyWebSocketContext,
  nuxt: Nuxt,
) {
  const getContents = () => {
    const sr = Array.from(serverRoutes.values())
    const sc = Array.from(serverConnection.values())

    const imports = [
      '// server-routes',
      ...sr.map((r) => genImport(r.filePath, r.name, { singleQuotes: true })),
      '',
      '// server-connection',
      ...sc.map((c) =>
        genImport(c.filePath, `_${c.name}`, { singleQuotes: true }),
      ),
    ].join('\n')

    return `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
${imports}

export const serverRoutes = [
  ${sr.map((r) => `{ name: '${r.routePath}', handler: ${r.name} },`).join('\n  ')}
];

export const serverConnection = [
  ${sc.map((c) => `{ type: '${c.name}', handler: _${c.name} },`).join('\n  ')}
]
`
  }

  // Add the template to Nuxt build
  const { dst } = addTemplate({
    filename: MODULE_TMP_PATH.serverEvents,
    write: true,
    getContents,
  })

  // Make the generated template available to nuxt
  nuxt.options.alias['#nuxt-easy-websocket/server'] = dst
  nuxt.options.build.transpile.push('#nuxt-easy-websocket/server')

  // generate declaration file
  const typeImportPath = resolver.resolve('./runtime/shared-types')
  const generatedTypeTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
declare module '#nuxt-easy-websocket/server' {
  import type { EasyWSServerConnectionGenerated, EasyWSServerEventGenerated } from '${typeImportPath}';
  export declare const serverRoutes: EasyWSServerEventGenerated<any>[];
  export declare const serverConnection: EasyWSServerConnectionGenerated[];
}
`
  // Add the type template to Nitro
  addTypeTemplate(
    {
      filename: MODULE_TMP_PATH.serverEventTypes,
      getContents: () => generatedTypeTemplate,
    },
    { nitro: true },
  )
}
