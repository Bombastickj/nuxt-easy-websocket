import { addTypeTemplate } from '@nuxt/kit'
import { MODULE_TMP_PATH } from '../constants'

import type { Nuxt } from 'nuxt/schema'
import type { NuxtEasyWebSocketContext } from '../types'

export function generateRouteTypes(ctx: NuxtEasyWebSocketContext, nuxt: Nuxt) {
  const { clientRoutes, serverRoutes, resolver } = ctx
  const typeImportPath = resolver.resolve('./runtime/shared-types')

  const getContents = () => {
    const defaultClient = Array.from(clientRoutes.get('default')!.values())
    const externalKeys = Array.from(clientRoutes.keys()).filter(
      (k) => k !== 'default',
    )

    return `/**
* This file is auto-generated by nuxt-easy-websocket.
* Do not edit this file manually.
*/
import type { EasyWSClientArgs, EasyWSServerArgs } from '${typeImportPath}';

declare module '#nuxt-easy-websocket/routes' {
  interface EasyWSClientRoutes {
    ${defaultClient.map((r) => `'${r.routePath}': ${r.type}`).join('\n    ')}
  }
  interface EasyWSServerRoutes {
    ${Array.from(serverRoutes.values())
      .map((r) => `'${r.routePath}': ${r.type}`)
      .join('\n    ')}
  }
  interface EasyWSExternalRoutes {
    ${externalKeys.map((ns) => `'${ns}': { }`).join('\n    ')}
  }

  // Resolved types for send args (client/server)
  type EasyWSClientArguments<KEY extends keyof EasyWSServerRoutes = keyof EasyWSServerRoutes> = EasyWSClientArgs<EasyWSServerRoutes, KEY>
  type EasyWSServerArguments<KEY extends keyof EasyWSClientRoutes = keyof EasyWSClientRoutes> = EasyWSServerArgs<EasyWSClientRoutes, KEY>
  type EasyWSExternalArguments<
    SOCKET extends keyof EasyWSExternalRoutes = keyof EasyWSExternalRoutes,
    KEY extends keyof EasyWSExternalRoutes[SOCKET] = keyof EasyWSExternalRoutes[SOCKET]
  > = EasyWSClientArgs<EasyWSExternalRoutes[SOCKET], KEY>
}
`
  }

  // Add the generated types to the Nuxt build
  const { dst } = addTypeTemplate(
    {
      filename: MODULE_TMP_PATH.routes,
      write: true,
      getContents,
    },
    { nitro: true, nuxt: true },
  )

  // Make the generated template available to the server handler
  nuxt.options.alias['#nuxt-easy-websocket/routes'] = dst
}
