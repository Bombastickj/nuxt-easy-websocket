import { genDynamicImport, genImport } from 'knitwork'
import { addTemplate, addTypeTemplate } from '@nuxt/kit'
import type { Nuxt } from '@nuxt/schema'
import type { NuxtEasyWebSocketContext } from './types'

export function generateRouteTypes(
  { clientRoutes, serverRoutes }: NuxtEasyWebSocketContext,
  nuxt: Nuxt,
) {
  const generatedTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
declare module '#nuxt-easy-websocket/routes' {
  interface EasyWSClientRoutes {
    ${clientRoutes['default'].map(route => `'${route.routePath}': Parameters<typeof ${genDynamicImport(route.filePath, { wrapper: false, singleQuotes: true })}.default>[0]['data']`).join('\n    ')}
  }
  interface EasyWSServerRoutes {
    ${serverRoutes.map(route => `'${route.routePath}': Parameters<typeof ${genDynamicImport(route.filePath, { wrapper: false, singleQuotes: true })}.default>[0]['data']`).join('\n    ')}
  }
  interface EasyWSExternalRoutes {
    ${Object.keys(clientRoutes).filter(key => key !== 'default').map(key => `${key}: { }`).join('\n    ')}
  }
}
`
  // Add the generated types to the Nuxt build
  const { dst } = addTypeTemplate({
    filename: 'types/nuxt-easy-websocket-routes.d.ts',
    getContents: () => generatedTemplate,
    write: true,
  }, { nitro: true, nuxt: true })
  // Make the generated template available to the server handler
  nuxt.options.alias['#nuxt-easy-websocket/routes'] = dst
}

export function generatePluginTypes({ resolver }: NuxtEasyWebSocketContext) {
  const typeImportPath = resolver.resolve('runtime/shared-types')
  const generatedTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
import type { EasyWSClientState } from '${typeImportPath}';
import type { EasyWSServerRoutes, EasyWSExternalRoutes } from '#nuxt-easy-websocket/routes';

type NuxtEasyWebSocketPlugin = {
  send: <T extends keyof EasyWSServerRoutes>(name: T, data?: EasyWSServerRoutes[T]) => Promise<void>
  state: Readonly<Ref<EasyWSClientState>>
  connectionStatus: ComputedRef<"connecting" | "connected" | "closing" | "disconnected" | "unknown">
  maxReconnectAttemptsReached: ComputedRef<boolean>

  connect: () => void
  disconnect: () => void | undefined
  forceReconnect: () => void

  // External WebSockets
  external: {
    [K in keyof EasyWSExternalRoutes]: {
      send: <T extends keyof EasyWSExternalRoutes[K]>(name: T, data?: EasyWSExternalRoutes[K][T]) => Promise<void>
      state: Readonly<Ref<EasyWSClientState>>
      connectionStatus: ComputedRef<"connecting" | "connected" | "closing" | "disconnected" | "unknown">
      maxReconnectAttemptsReached: ComputedRef<boolean>
      connect: () => void
      disconnect: () => void | undefined
      forceReconnect: () => void
    }
  }
}

declare module '#app' {
  interface NuxtApp {
    $easyWS: NuxtEasyWebSocketPlugin
  }
}

declare module 'vue' {
  interface ComponentCustomProperties {
    $easyWS: NuxtEasyWebSocketPlugin
  }
}

export {}
`
  // Add the generated types to the Nuxt build
  addTypeTemplate({
    filename: 'types/nuxt-easy-websocket-plugin.d.ts',
    getContents: () => generatedTemplate,
    write: true,
  })
}

export function generateClientEvents(
  { resolver, clientRoutes }: NuxtEasyWebSocketContext,
  nuxt: Nuxt,
) {
  const generatedTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
${Object.keys(clientRoutes).flatMap(key => clientRoutes[key].map(route => genImport(route.filePath, `${key}_${route.name}`, { singleQuotes: true }))).join('\n')}

export const clientRoutes = {
  ${Object.keys(clientRoutes).map(key => `${key}: [${clientRoutes[key].map(route => `{ name: '${route.routePath}', handler: ${key}_${route.name} }`).join(',\n  ')}]`).join(',\n  ')}
}
`
  // Add the generated types to the Nuxt build
  const { dst } = addTemplate({
    filename: 'modules/nuxt-easy-websocket-client.mts',
    getContents: () => generatedTemplate,
    write: true,
  })

  // Make the generated template available to nuxt
  nuxt.options.alias['#nuxt-easy-websocket/client'] = dst
  nuxt.options.build.transpile.push('#nuxt-easy-websocket/client')

  const typeImportPath = resolver.resolve('runtime/shared-types')
  const generatedTypeTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
declare module '#nuxt-easy-websocket/client' {
  import type { EasyWSServerConnectionGenerated, EasyWSServerEventGenerated } from '${typeImportPath}';
  export declare const clientRoutes: Record<'default' | string, EasyWSClientEventGenerated<any>[]>;
}
`
  // Add the type template to nuxt
  addTypeTemplate({
    filename: 'modules/nuxt-easy-websocket-client.d.ts',
    getContents: () => generatedTypeTemplate,
    write: true,
  })
}

export function generateServerEvents(
  { resolver, serverRoutes, serverConnection }: NuxtEasyWebSocketContext,
  nuxt: Nuxt,
) {
  const generatedTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
// server-routes
${serverRoutes.map(route => genImport(route.filePath, route.name, { singleQuotes: true })).join('\n')}

// server-connection
${serverConnection.map(con => genImport(con.filePath, `_${con.name}`, { singleQuotes: true })).join('\n')}

export const serverRoutes = [
  ${serverRoutes.map(route => `{ name: '${route.routePath}', handler: ${route.name} }`).join(',\n  ')}
];

export const serverConnection = [
  ${serverConnection.map(con => `{ type: '${con.name}', handler: _${con.name} }`).join(',\n  ')}
]
`
  // Add the template to Nuxt build
  const { dst } = addTemplate({
    filename: 'modules/nuxt-easy-websocket-server.mts',
    getContents: () => generatedTemplate,
    write: true,
  })

  // Make the generated template available to nuxt
  nuxt.options.alias['#nuxt-easy-websocket/server'] = dst
  nuxt.options.build.transpile.push('#nuxt-easy-websocket/server')

  // generate declaration file
  const typeImportPath = resolver.resolve('runtime/shared-types')
  const generatedTypeTemplate = `/**
* This file is auto-generated by nuxt-easy-websocket module.
* Do not edit this file manually.
*/
declare module '#nuxt-easy-websocket/server' {
  import type { EasyWSServerConnectionGenerated, EasyWSServerEventGenerated } from '${typeImportPath}';
  export declare const serverRoutes: EasyWSServerEventGenerated<any>[];
  export declare const serverConnection: EasyWSServerConnectionGenerated[];
}
`
  // Add the type template to Nitro
  addTypeTemplate({
    filename: 'modules/nuxt-easy-websocket-server.d.ts',
    getContents: () => generatedTypeTemplate,
  }, { nitro: true })
}
